import sqlite3

_connection = None

def get_connection():
    global _connection
    if _connection is None:
        _connection = sqlite3.connect('anketa.db')
    return _connection

def init_db(force: bool = False):
    # Проверить, что нужные таблицы существуют иначе создать их
    conn = get_connection()

    c = conn.cursor()

    if force:
        c.execute('DROP TABLE IF EXISTS user_message')

    c.execute('''
        CREATE TABLE IF NOT EXISTS user_message (
        id       INTEGER PRIMARY KEY,
        user_id  INTEGER NOT NULL,
        text     TEXT NOT NULL
        )
    ''')

    conn.commit()

def add_message(user_id: int, text: str):
    conn = get_connection()
    c = conn.cursor()
    c.execute('INSERT INTO user_message (user_id, text) VALUES (?, ?)', (user_id, text))
    conn.commit()
    conn.close()

def count_message(user_id: int):
    conn = get_connection()
    c = conn.cursor()
    c.execute('SELECT COUNT (*) FROM  user_message WHERE user_id = ?', (user_id, ))
    (res, ) = c.fetchone()
    #conn.close()
    return res

def list_message(user_id: int, limit: int = 10):
    conn = get_connection()
    c = conn.cursor()
    c.execute('SELECT id, text FROM  user_message WHERE user_id = ? ORDER BY id DESC LIMIT ?', (user_id, limit ))
    return c.fetchall()

#init_db()

#add_message(user_id=1000, text='Привет Вера5')

'''
r = count_message(user_id=2222)
print(r)

r = list_message(user_id=2222, limit=3)
for i in r:
    print(i)
'''
